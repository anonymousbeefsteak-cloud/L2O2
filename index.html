<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>台灣小吃店 - LINE訂餐系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* For the spinner animation */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-300 via-purple-400 to-pink-300">

    <div class="p-4">
        <!-- Notification -->
        <div id="notification" class="fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg text-white hidden"></div>

        <div class="max-w-md mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
            <header class="bg-green-600 text-white p-5 text-center">
                <h1 class="text-2xl font-bold">🍜 台灣小吃店</h1>
                <p class="text-sm">LINE 快速訂餐系統</p>
            </header>

            <main class="p-5">
                <div id="userInfo" class="bg-green-100 text-green-800 p-3 rounded-lg mb-4 text-center text-sm">
                    🔄 載入 LINE 資訊中...
                </div>

                <!-- Submitted Order View -->
                <div id="submittedOrderView" class="hidden bg-blue-50 border border-blue-200 p-4 rounded-lg text-center">
                     <h2 class="text-lg font-bold text-blue-800 mb-2">訂單已送出！</h2>
                     <p>訂單編號: <span id="submittedOrderId" class="font-mono bg-blue-100 px-2 py-1 rounded"></span></p>
                     <div id="orderStatusTracker" class="relative my-8">
                        <!-- Status tracker will be rendered here by JS -->
                     </div>
                </div>

                <!-- Main Ordering Form -->
                <div id="orderingForm">
                    <!-- User Info Form -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700">姓名 <small>(自動帶入)</small></label>
                            <input type="text" id="customerName" readonly class="w-full mt-1 p-3 border-2 border-gray-200 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed"/>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700">LINE User ID <small>(自動帶入)</small></label>
                            <input type="text" id="customerLineId" readonly class="w-full mt-1 p-3 border-2 border-gray-200 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed"/>
                        </div>
                        <div id="phoneGroup">
                            <label for="customerPhone" class="block text-sm font-bold text-slate-700">手機號碼 <small>(必填)</small></label>
                            <input type="tel" id="customerPhone" placeholder="0912345678" required class="w-full mt-1 p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                            <p id="phoneError" class="text-red-500 text-xs mt-1 hidden"></p>
                        </div>
                        <div id="timeGroup">
                            <label for="pickupTime" class="block text-sm font-bold text-slate-700">取餐時間 <small>(必填)</small></label>
                            <input type="datetime-local" id="pickupTime" required class="w-full mt-1 p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                            <p id="timeError" class="text-red-500 text-xs mt-1 hidden"></p>
                        </div>
                         <div>
                            <label for="deliveryAddress" class="block text-sm font-bold text-slate-700">外送地點 <small>(選填)</small></label>
                            <input type="text" id="deliveryAddress" placeholder="如需外送請填寫地址" class="w-full mt-1 p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                        </div>
                    </div>

                    <!-- Menu -->
                    <div class="bg-gray-50 p-4 rounded-lg my-6">
                        <h2 class="text-center font-bold text-slate-800 mb-2">📝 選擇餐點</h2>
                        <select id="menuSelect" onchange="handleAddToCart(this)" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <!-- Menu options will be rendered here by JS -->
                        </select>
                    </div>
                    
                    <!-- Cart -->
                    <div class="bg-yellow-50 border-2 border-yellow-200 p-4 rounded-lg">
                         <h2 class="text-center font-bold text-slate-800 mb-2">🛒 訂單明細</h2>
                         <div id="cartItems" class="space-y-3">
                            <p class="text-center text-gray-500 italic py-4">尚未選擇餐點</p>
                         </div>
                    </div>

                    <!-- Notes -->
                     <div class="mt-6">
                        <label for="notes" class="block text-sm font-bold text-slate-700">備註 (選填)</label>
                        <textarea id="notes" rows="2" placeholder="例如：不要香菜、加辣等" class="w-full mt-1 p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <!-- Summary -->
                    <div class="bg-green-50 p-4 rounded-lg my-6 text-sm space-y-2">
                        <div class="flex justify-between"><span>餐點總計:</span><span id="subtotal">$0</span></div>
                        <div class="flex justify-between"><span>外送費:</span><span id="deliveryFee">$0</span></div>
                        <div class="flex justify-between font-bold text-base border-t pt-2 mt-2"><span>總金額:</span><span id="totalAmount">$0</span></div>
                    </div>
                </div>

                <!-- Confirmation View -->
                <div id="confirmationView" class="hidden bg-green-50 border-2 border-green-200 p-4 rounded-lg my-6">
                    <h2 class="text-center font-bold text-green-800 mb-2">📋 訂單確認</h2>
                    <div id="confirmationDetails" class="space-y-2 text-sm">
                        <!-- Confirmation details will be rendered here by JS -->
                    </div>
                    <div class="flex gap-4 mt-4">
                        <button onclick="handleConfirmOrder()" class="flex-1 p-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700">確認訂單</button>
                        <button onclick="cancelConfirmation()" class="flex-1 p-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600">修改訂單</button>
                    </div>
                </div>
                
                <!-- Loading View -->
                <div id="loadingView" class="hidden text-center py-6">
                    <div class="w-8 h-8 border-4 border-gray-200 border-t-green-600 rounded-full animate-spin mx-auto mb-2"></div>
                    <p>訂單發送中...</p>
                </div>
                
                <!-- Submit Button -->
                <div id="submitButtonContainer">
                     <button id="submitBtn" onclick="handlePrepareOrder()" disabled class="w-full p-4 bg-green-600 text-white rounded-lg font-bold text-lg hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        ✅ 送出訂單
                    </button>
                </div>
            </main>
        </div>
    </div>
    
    <script>
    // --- START OF LOGIC FROM constants.ts ---
    const CONFIG = {
        LIFF_ID: '2008289130-9XPR8Kpj',
        API_ENDPOINT: 'https://script.google.com/macros/s/AKfycbxYq5ry_GiWmg_6-p3StyPiOV6TaicKZqFtsDjp3LZtAcieJlbS9J-mcCpO7LHf0mQ/exec'
    };

    const MENU_ITEMS = [
        { name: '滷肉飯', price: 35, icon: '🍚' },
        { name: '雞肉飯', price: 40, icon: '🍗' },
        { name: '蚵仔煎', price: 65, icon: '🍳' },
        { name: '大腸麵線', price: 50, icon: '🍜' },
        { name: '珍珠奶茶', price: 45, icon: '🥤' },
        { name: '鹽酥雞', price: 60, icon: '🍖' },
        { name: '甜不辣', price: 40, icon: '🍢' },
        { name: '肉圓', price: 45, icon: '🥟' }
    ];

    const DELIVERY_FEE = 30;
    // --- END OF LOGIC FROM constants.ts ---

    // --- STATE MANAGEMENT ---
    let userProfile = null;
    let liffError = '';
    let cart = [];
    
    // --- DOM ELEMENT REFERENCES ---
    const getEl = (id) => document.getElementById(id);
    const elements = {
        notification: getEl('notification'),
        userInfo: getEl('userInfo'),
        customerName: getEl('customerName'),
        customerLineId: getEl('customerLineId'),
        customerPhone: getEl('customerPhone'),
        pickupTime: getEl('pickupTime'),
        deliveryAddress: getEl('deliveryAddress'),
        notes: getEl('notes'),
        menuSelect: getEl('menuSelect'),
        cartItems: getEl('cartItems'),
        subtotal: getEl('subtotal'),
        deliveryFee: getEl('deliveryFee'),
        totalAmount: getEl('totalAmount'),
        phoneGroup: getEl('phoneGroup'),
        timeGroup: getEl('timeGroup'),
        phoneError: getEl('phoneError'),
        timeError: getEl('timeError'),
        submitBtn: getEl('submitBtn'),
        orderingForm: getEl('orderingForm'),
        confirmationView: getEl('confirmationView'),
        confirmationDetails: getEl('confirmationDetails'),
        loadingView: getEl('loadingView'),
        submitButtonContainer: getEl('submitButtonContainer'),
        submittedOrderView: getEl('submittedOrderView'),
        submittedOrderId: getEl('submittedOrderId'),
        orderStatusTracker: getEl('orderStatusTracker'),
    };
    
    // --- NOTIFICATION ---
    function showNotification(message, type = 'success') {
        elements.notification.textContent = message;
        elements.notification.className = `fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        elements.notification.classList.remove('hidden');
        setTimeout(() => {
            elements.notification.classList.add('hidden');
        }, 3000);
    }
    
    // --- RENDER FUNCTIONS ---
    function renderCart() {
        if (cart.length === 0) {
            elements.cartItems.innerHTML = '<p class="text-center text-gray-500 italic py-4">尚未選擇餐點</p>';
        } else {
            elements.cartItems.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center py-2 border-b last:border-b-0 border-gray-200">
                    <div>
                        <p class="font-bold">${item.icon} ${item.name}</p>
                        <p class="text-xs text-gray-500">$${item.price} x ${item.quantity} = $${item.price * item.quantity}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="handleQuantityChange('${item.name}', -1)" class="w-7 h-7 bg-green-600 text-white rounded-full font-bold text-sm hover:bg-green-700">-</button>
                        <span class="w-6 text-center">${item.quantity}</span>
                        <button onclick="handleQuantityChange('${item.name}', 1)" class="w-7 h-7 bg-green-600 text-white rounded-full font-bold text-sm hover:bg-green-700">+</button>
                        <button onclick="handleRemoveItem('${item.name}')" class="bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600">刪除</button>
                    </div>
                </div>
            `).join('');
        }
        updateOrderSummary();
    }

    function updateOrderSummary() {
        const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const fee = elements.deliveryAddress.value.trim() ? DELIVERY_FEE : 0;
        const total = subtotal + fee;

        elements.subtotal.textContent = `$${subtotal}`;
        elements.deliveryFee.textContent = `$${fee}`;
        elements.totalAmount.textContent = `$${total}`;
        
        elements.submitBtn.disabled = cart.length === 0 || !userProfile;
    }
    
    function renderOrderStatusTracker(status) {
        const steps = ['已下單', '準備中', '可取餐', '已完成'];
        let activeStep = 1;
        if (status === 'confirmed') activeStep = 2;
        if (status === 'ready') activeStep = 3;
        if (status === 'completed') activeStep = 4;

        elements.orderStatusTracker.innerHTML = `
            <div class="absolute top-1/2 left-0 w-full h-0.5 bg-gray-200 -translate-y-1/2"></div>
            <div class="absolute top-1/2 left-0 h-0.5 bg-green-600 -translate-y-1/2" style="width: ${(activeStep - 1) / (steps.length - 1) * 100}%"></div>
            <div class="relative flex justify-between">
                ${steps.map((label, index) => `
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold z-10 ${index + 1 <= activeStep ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-500'}">
                            ${index + 1}
                        </div>
                        <span class="mt-2 text-xs text-center">${label}</span>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // --- EVENT HANDLERS ---
    function handleAddToCart(selectElement) {
        const itemName = selectElement.value;
        if (!itemName) return;
        
        const menuItem = MENU_ITEMS.find(item => item.name === itemName);
        if (!menuItem) return;

        const existingItem = cart.find(item => item.name === itemName);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...menuItem, quantity: 1 });
        }
        
        selectElement.value = '';
        showNotification(`已添加 ${itemName}`);
        renderCart();
    }
    
    function handleQuantityChange(itemName, change) {
        const item = cart.find(i => i.name === itemName);
        if (!item) return;

        const newQuantity = item.quantity + change;
        if (newQuantity <= 0) {
            handleRemoveItem(itemName);
        } else {
            item.quantity = newQuantity;
            renderCart();
        }
    }
    
    function handleRemoveItem(itemName) {
        cart = cart.filter(item => item.name !== itemName);
        showNotification(`已移除 ${itemName}`);
        renderCart();
    }
    
    function validateForm() {
        let isValid = true;
        // Phone validation
        if (!/^09\d{8}$/.test(elements.customerPhone.value)) {
            elements.phoneGroup.classList.add('border-red-500');
            elements.phoneError.textContent = '請輸入正確的手機號碼 (09開頭，10位數字)';
            elements.phoneError.classList.remove('hidden');
            isValid = false;
        } else {
            elements.phoneGroup.classList.remove('border-red-500');
            elements.phoneError.classList.add('hidden');
        }
        // Time validation
        if (!elements.pickupTime.value) {
            elements.timeGroup.classList.add('border-red-500');
            elements.timeError.textContent = '請選擇取餐時間';
            elements.timeError.classList.remove('hidden');
            isValid = false;
        } else {
            elements.timeGroup.classList.remove('border-red-500');
            elements.timeError.classList.add('hidden');
        }

        if (cart.length === 0) {
            showNotification('請選擇至少一樣餐點', 'error');
            isValid = false;
        }
        
        return isValid;
    }

    function handlePrepareOrder() {
        if (validateForm()) {
            const orderDetailsHTML = `
                <div class="flex justify-between"><span>姓名:</span><span>${userProfile?.displayName}</span></div>
                <div class="flex justify-between"><span>手機:</span><span>${elements.customerPhone.value}</span></div>
                <div class="flex justify-between"><span>取餐時間:</span><span>${new Date(elements.pickupTime.value).toLocaleString('zh-TW')}</span></div>
                ${elements.deliveryAddress.value ? `<div class="flex justify-between"><span>外送地址:</span><span>${elements.deliveryAddress.value}</span></div>` : ''}
                <table class="w-full my-2 text-left">
                    <thead><tr class="border-b"><th class="py-1">餐點</th><th class="py-1">數量</th><th class="py-1 text-right">小計</th></tr></thead>
                    <tbody>${cart.map(i => `<tr><td class="py-1">${i.icon} ${i.name}</td><td class="py-1">${i.quantity}</td><td class="py-1 text-right">$${i.price * i.quantity}</td></tr>`).join('')}</tbody>
                </table>
                <div class="flex justify-between font-bold border-t pt-2"><span>總金額:</span><span>${elements.totalAmount.textContent}</span></div>
                ${elements.notes.value ? `<div class="pt-2"><span>備註: ${elements.notes.value}</span></div>` : ''}
            `;
            elements.confirmationDetails.innerHTML = orderDetailsHTML;
            
            // Switch views
            elements.orderingForm.classList.add('hidden');
            elements.submitButtonContainer.classList.add('hidden');
            elements.confirmationView.classList.remove('hidden');
        }
    }

    function cancelConfirmation() {
        elements.orderingForm.classList.remove('hidden');
        elements.submitButtonContainer.classList.remove('hidden');
        elements.confirmationView.classList.add('hidden');
    }

    async function handleConfirmOrder() {
        if (!userProfile) {
            showNotification('無法獲取 LINE 用戶資訊，請稍後再試。', 'error');
            return;
        }

        elements.confirmationView.classList.add('hidden');
        elements.loadingView.classList.remove('hidden');

        const totalAmount = cart.reduce((s, i) => s + i.price * i.quantity, 0) + (elements.deliveryAddress.value.trim() ? DELIVERY_FEE : 0);

        const orderPayload = {
            action: 'createOrder',
            orderData: {
                customerName: userProfile.displayName,
                customerPhone: elements.customerPhone.value,
                customerLineUserId: userProfile.userId,
                pickupTime: elements.pickupTime.value,
                deliveryAddress: elements.deliveryAddress.value,
                notes: elements.notes.value,
                items: cart,
                totalAmount: totalAmount,
                status: 'pending'
            }
        };

        try {
            const response = await fetch(CONFIG.API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(orderPayload)
            });

            if (!response.ok) throw new Error(`伺服器錯誤: ${response.status}`);

            const result = await response.json();
            
            if (result.success) {
                elements.submittedOrderId.textContent = result.data.orderId;
                renderOrderStatusTracker(result.data.orderData.status);
                elements.submittedOrderView.classList.remove('hidden');
                elements.loadingView.classList.add('hidden');
                showNotification(`✅ 訂單成功！編號: ${result.data.orderId}`, 'success');
            } else {
                throw new Error(result.message || '訂單發送失敗');
            }
        } catch (error) {
            showNotification(`❌ 發送失敗: ${error.message}`, 'error');
            elements.loadingView.classList.add('hidden');
            elements.orderingForm.classList.remove('hidden');
            elements.submitButtonContainer.classList.remove('hidden');
        }
    }


    // --- INITIALIZATION ---
    function setDefaultPickupTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        elements.pickupTime.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function populateMenu() {
        elements.menuSelect.innerHTML = '<option value="">-- 請選擇餐點 --</option>' + 
            MENU_ITEMS.map(item => `<option value="${item.name}">${item.icon} ${item.name} - $${item.price}</option>`).join('');
    }

    async function initializeLiff() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                userProfile = { userId: profile.userId, displayName: profile.displayName };
                elements.userInfo.textContent = `👋 歡迎，${userProfile.displayName}`;
                elements.customerName.value = userProfile.displayName;
                elements.customerLineId.value = userProfile.userId;
            } else {
                liffError = '請在 LINE 中開啟以獲得最佳體驗';
                elements.userInfo.textContent = liffError;
            }
        } catch (error) {
            console.error('LIFF initialization failed', error);
            liffError = `LINE 功能載入失敗: ${error.message}`;
            elements.userInfo.textContent = liffError;
        } finally {
            updateOrderSummary();
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initializeLiff();
        setDefaultPickupTime();
        populateMenu();
        elements.deliveryAddress.addEventListener('input', updateOrderSummary);
    });

    </script>
</body>
</html>
