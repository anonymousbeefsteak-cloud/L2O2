<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>台灣小吃店 - 店家管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f7fafc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .print-only { display: none; }
        @media print {
            .no-print { display: none; }
            .print-only { display: block; }
            body { background: white; }
            .order-details { break-inside: avoid; }
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback, useEffect, useMemo } = React;

        // 菜單項目
        const MENU_ITEMS = [
            { name: '滷肉飯', price: 35, icon: '🍚' },
            { name: '雞肉飯', price: 40, icon: '🍗' },
            { name: '蚵仔煎', price: 65, icon: '🍳' },
            { name: '大腸麵線', price: 50, icon: '🍜' },
            { name: '珍珠奶茶', price: 45, icon: '🥤' },
            { name: '鹽酥雞', price: 60, icon: '🍖' },
            { name: '甜不辣', price: 40, icon: '🍢' },
            { name: '肉圓', price: 45, icon: '🥟' },
            { name: '臭豆腐', price: 55, icon: '🧆' },
            { name: '牛肉麵', price: 120, icon: '🍲' }
        ];

        // 生成測試資料
        const generateTestData = () => {
            const orders = [];
            const statuses = ['pending', 'confirmed', 'preparing', 'ready', 'completed'];
            const customers = ['王小明', '陳小華', '林小美', '張小強', '李小雯', '黃小龍', '劉小婷'];
            const addresses = ['', '台北市信義區忠孝東路五段100號', '台北市大安區仁愛路四段50號', ''];
            
            // 生成過去30天的資料
            for (let i = 0; i < 100; i++) {
                const daysAgo = Math.floor(Math.random() * 30);
                const orderDate = new Date();
                orderDate.setDate(orderDate.getDate() - daysAgo);
                orderDate.setHours(10 + Math.floor(Math.random() * 10), Math.floor(Math.random() * 60));
                
                const itemCount = Math.floor(Math.random() * 4) + 1;
                const items = [];
                let totalAmount = 0;
                
                for (let j = 0; j < itemCount; j++) {
                    const menuItem = MENU_ITEMS[Math.floor(Math.random() * MENU_ITEMS.length)];
                    const quantity = Math.floor(Math.random() * 3) + 1;
                    items.push({
                        name: menuItem.name,
                        price: menuItem.price,
                        quantity: quantity,
                        icon: menuItem.icon
                    });
                    totalAmount += menuItem.price * quantity;
                }
                
                const customerIndex = Math.floor(Math.random() * customers.length);
                const addressIndex = Math.floor(Math.random() * addresses.length);
                const statusIndex = Math.floor(Math.random() * statuses.length);
                
                orders.push({
                    orderId: `ORD${String(1000 + i).slice(1)}`,
                    customerName: customers[customerIndex],
                    customerPhone: `09${String(10000000 + Math.floor(Math.random() * 90000000)).slice(1)}`,
                    items: items,
                    totalAmount: totalAmount,
                    status: statuses[statusIndex],
                    pickupTime: new Date(orderDate.getTime() + 30 * 60000).toISOString(),
                    deliveryAddress: addresses[addressIndex],
                    notes: Math.random() > 0.7 ? '不要加辣' : (Math.random() > 0.5 ? '需要餐具' : ''),
                    createdAt: orderDate.toISOString(),
                    confirmedAt: statuses[statusIndex] !== 'pending' ? new Date(orderDate.getTime() + 5 * 60000).toISOString() : null
                });
            }
            
            return orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        };

        // API 服務
        const apiService = {
            getAllOrders: async () => {
                try {
                    // 模擬 API 呼叫延遲
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // 返回測試資料
                    return {
                        success: true,
                        data: generateTestData()
                    };
                } catch (error) {
                    console.error('API 請求失敗:', error);
                    throw error;
                }
            },

            confirmOrder: async (orderId, adminNotes) => {
                try {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return { success: true, message: '訂單確認成功' };
                } catch (error) {
                    console.error('確認訂單 API 失敗:', error);
                    throw error;
                }
            },

            updateOrderStatus: async (orderId, status) => {
                try {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return { success: true, message: '狀態更新成功' };
                } catch (error) {
                    console.error('更新狀態 API 失敗:', error);
                    throw error;
                }
            }
        };

        // 加載動畫組件
        const LoadingSpinner = () => (
            <div className="flex items-center justify-center">
                <svg className="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        );

        // 通知組件
        const Notification = ({ message, type, visible, onClose }) => {
            if (!visible) return null;
            
            const typeClasses = {
                success: "bg-green-500 text-white",
                error: "bg-red-500 text-white",
                warning: "bg-yellow-500 text-white",
                info: "bg-blue-500 text-white"
            };
            
            return (
                <div className={`fixed top-5 right-5 max-w-sm p-4 rounded-lg shadow-lg z-50 animate-fade-in ${typeClasses[type]}`}>
                    <div className="flex justify-between items-center">
                        <p className="text-sm font-medium whitespace-pre-wrap">{message}</p>
                        <button onClick={onClose} className="ml-4 text-xl font-bold leading-none hover:opacity-70">
                            &times;
                        </button>
                    </div>
                </div>
            );
        };

        // 銷售統計卡片組件
        const StatCard = ({ title, value, subtitle, icon, color, trend }) => (
            <div className={`stat-card bg-white rounded-lg p-6 border-l-4 ${color} shadow-sm`}>
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm font-medium text-gray-600">{title}</p>
                        <p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>
                        {subtitle && <p className="text-sm text-gray-500 mt-1">{subtitle}</p>}
                        {trend && (
                            <p className={`text-xs font-medium mt-2 ${trend.value > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trend.value > 0 ? '↗' : '↘'} {Math.abs(trend.value)}% {trend.label}
                            </p>
                        )}
                    </div>
                    <div className="text-3xl opacity-80">
                        {icon}
                    </div>
                </div>
            </div>
        );

        // 銷售統計組件
        const SalesStatistics = ({ orders, currentView, onViewChange }) => {
            const [dateRange, setDateRange] = useState('today');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));

            // 獲取日期範圍
            const getDateRange = useMemo(() => {
                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                
                const [year, month] = selectedMonth.split('-').map(Number);
                const startOfSelectedMonth = new Date(year, month - 1, 1);
                const endOfSelectedMonth = new Date(year, month, 0, 23, 59, 59);

                return {
                    today: { start: startOfDay, end: now },
                    month: { start: startOfMonth, end: now },
                    year: { start: startOfYear, end: now },
                    custom: { start: startOfSelectedMonth, end: endOfSelectedMonth }
                }[dateRange];
            }, [dateRange, selectedMonth]);

            // 篩選訂單
            const filteredOrders = useMemo(() => {
                const { start, end } = getDateRange;
                return orders.filter(order => {
                    const orderDate = new Date(order.createdAt);
                    return orderDate >= start && orderDate <= end && order.status !== 'cancelled';
                });
            }, [orders, getDateRange]);

            // 計算統計數據
            const statistics = useMemo(() => {
                // 營業額統計
                const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.totalAmount, 0);

                // 客數統計
                const customerCount = filteredOrders.length;

                // 熱門商品統計
                const itemSales = {};
                filteredOrders.forEach(order => {
                    order.items.forEach(item => {
                        const itemName = item.name;
                        if (!itemSales[itemName]) {
                            itemSales[itemName] = { quantity: 0, revenue: 0, icon: item.icon };
                        }
                        itemSales[itemName].quantity += item.quantity;
                        itemSales[itemName].revenue += item.price * item.quantity;
                    });
                });

                // 轉換為陣列並排序
                const popularItems = Object.entries(itemSales)
                    .map(([name, data]) => ({ name, ...data }))
                    .sort((a, b) => b.quantity - a.quantity);

                // 每日數據（用於圖表）
                const dailyData = {};
                filteredOrders.forEach(order => {
                    const date = new Date(order.createdAt).toLocaleDateString('zh-TW');
                    if (!dailyData[date]) {
                        dailyData[date] = { revenue: 0, customers: 0, orders: 0 };
                    }
                    dailyData[date].revenue += order.totalAmount;
                    dailyData[date].customers += 1;
                    dailyData[date].orders += 1;
                });

                // 每月數據
                const monthlyData = {};
                filteredOrders.forEach(order => {
                    const month = new Date(order.createdAt).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });
                    if (!monthlyData[month]) {
                        monthlyData[month] = { revenue: 0, customers: 0, orders: 0 };
                    }
                    monthlyData[month].revenue += order.totalAmount;
                    monthlyData[month].customers += 1;
                    monthlyData[month].orders += 1;
                });

                return {
                    totalRevenue,
                    customerCount,
                    popularItems,
                    dailyData,
                    monthlyData,
                    averageOrderValue: customerCount > 0 ? totalRevenue / customerCount : 0,
                    totalOrders: filteredOrders.length
                };
            }, [filteredOrders]);

            // 圖表數據 - 營業額趨勢
            const revenueChartData = useMemo(() => {
                const dates = Object.keys(statistics.dailyData).sort();
                const revenueData = dates.map(date => statistics.dailyData[date].revenue);
                const customerData = dates.map(date => statistics.dailyData[date].customers);

                return {
                    labels: dates,
                    datasets: [
                        {
                            label: '每日營業額',
                            data: revenueData,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                };
            }, [statistics.dailyData]);

            // 圖表數據 - 客數趨勢
            const customerChartData = useMemo(() => {
                const dates = Object.keys(statistics.dailyData).sort();
                const customerData = dates.map(date => statistics.dailyData[date].customers);

                return {
                    labels: dates,
                    datasets: [
                        {
                            label: '每日客數',
                            data: customerData,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                };
            }, [statistics.dailyData]);

            // 熱門商品圖表數據
            const popularItemsChartData = useMemo(() => {
                const topItems = statistics.popularItems.slice(0, 8);
                return {
                    labels: topItems.map(item => item.name),
                    datasets: [{
                        label: '銷售數量',
                        data: topItems.map(item => item.quantity),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)'
                        ]
                    }]
                };
            }, [statistics.popularItems]);

            // 每月營業額圖表
            const monthlyRevenueChartData = useMemo(() => {
                const months = Object.keys(statistics.monthlyData).sort();
                const revenueData = months.map(month => statistics.monthlyData[month].revenue);
                
                return {
                    labels: months,
                    datasets: [{
                        label: '每月營業額',
                        data: revenueData,
                        backgroundColor: 'rgba(139, 69, 19, 0.8)',
                        borderColor: 'rgb(139, 69, 19)',
                        borderWidth: 2
                    }]
                };
            }, [statistics.monthlyData]);

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            };

            const revenueChartOptions = {
                ...chartOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '營業額 ($)'
                        }
                    }
                }
            };

            return (
                <div className="animate-fade-in">
                    <div className="flex items-center mb-6">
                        <button onClick={() => onViewChange('orders')} className="text-gray-600 hover:text-gray-800 mr-3">
                            ← 返回訂單管理
                        </button>
                        <h2 className="text-2xl font-bold">銷售統計報表</h2>
                    </div>

                    {/* 時間範圍選擇 */}
                    <div className="bg-white rounded-lg p-4 border border-gray-200 shadow-sm mb-6">
                        <div className="flex flex-wrap gap-4 items-center">
                            <label className="font-medium">統計期間:</label>
                            <select 
                                value={dateRange} 
                                onChange={(e) => setDateRange(e.target.value)}
                                className="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="today">今日</option>
                                <option value="month">本月</option>
                                <option value="year">今年</option>
                                <option value="custom">選擇月份</option>
                            </select>
                            
                            {dateRange === 'custom' && (
                                <input
                                    type="month"
                                    value={selectedMonth}
                                    onChange={(e) => setSelectedMonth(e.target.value)}
                                    className="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                                />
                            )}
                            
                            <div className="text-sm text-gray-600">
                                共 {statistics.totalOrders} 筆訂單，{statistics.customerCount} 位顧客
                            </div>
                        </div>
                    </div>

                    {/* 統計卡片 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <StatCard
                            title="總營業額"
                            value={`$${statistics.totalRevenue.toLocaleString()}`}
                            subtitle={`${dateRange === 'today' ? '今日' : dateRange === 'month' ? '本月' : '今年'}營業額`}
                            icon="💰"
                            color="border-l-blue-500"
                        />
                        <StatCard
                            title="總客數"
                            value={statistics.customerCount.toLocaleString()}
                            subtitle={`${dateRange === 'today' ? '今日' : dateRange === 'month' ? '本月' : '今年'}客數`}
                            icon="👥"
                            color="border-l-green-500"
                        />
                        <StatCard
                            title="平均客單價"
                            value={`$${Math.round(statistics.averageOrderValue)}`}
                            subtitle="每筆訂單平均金額"
                            icon="📊"
                            color="border-l-purple-500"
                        />
                        <StatCard
                            title="訂單數量"
                            value={statistics.totalOrders}
                            subtitle="成功交易訂單數"
                            icon="📦"
                            color="border-l-orange-500"
                        />
                    </div>

                    {/* 圖表區域 */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        {/* 營業額趨勢圖 */}
                        <div className="bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
                            <h3 className="text-lg font-bold mb-4">每日營業額趨勢</h3>
                            <div className="h-80">
                                <canvas></canvas>
                            </div>
                        </div>

                        {/* 客數趨勢圖 */}
                        <div className="bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
                            <h3 className="text-lg font-bold mb-4">每日客數趨勢</h3>
                            <div className="h-80">
                                <canvas></canvas>
                            </div>
                        </div>
                    </div>

                    {/* 每月營業額和熱門商品 */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        {/* 每月營業額 */}
                        <div className="bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
                            <h3 className="text-lg font-bold mb-4">每月營業額</h3>
                            <div className="h-80">
                                <canvas></canvas>
                            </div>
                        </div>

                        {/* 熱門商品銷售 */}
                        <div className="bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
                            <h3 className="text-lg font-bold mb-4">熱門商品銷售排行</h3>
                            <div className="h-80">
                                <canvas></canvas>
                            </div>
                        </div>
                    </div>

                    {/* 詳細銷售表格 */}
                    <div className="bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
                        <h3 className="text-lg font-bold mb-4">商品銷售明細</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full border-collapse">
                                <thead>
                                    <tr className="bg-gray-50">
                                        <th className="border border-gray-200 p-3 text-left">排名</th>
                                        <th className="border border-gray-200 p-3 text-left">商品名稱</th>
                                        <th className="border border-gray-200 p-3 text-center">銷售數量</th>
                                        <th className="border border-gray-200 p-3 text-right">銷售金額</th>
                                        <th className="border border-gray-200 p-3 text-right">佔比</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {statistics.popularItems.map((item, index) => (
                                        <tr key={index} className="hover:bg-gray-50">
                                            <td className="border border-gray-200 p-3 font-medium">#{index + 1}</td>
                                            <td className="border border-gray-200 p-3">
                                                <div className="flex items-center gap-2">
                                                    <span>{item.icon}</span>
                                                    <span>{item.name}</span>
                                                </div>
                                            </td>
                                            <td className="border border-gray-200 p-3 text-center">{item.quantity}</td>
                                            <td className="border border-gray-200 p-3 text-right">${item.revenue.toLocaleString()}</td>
                                            <td className="border border-gray-200 p-3 text-right">
                                                {statistics.totalRevenue > 0 
                                                    ? `${((item.revenue / statistics.totalRevenue) * 100).toFixed(1)}%`
                                                    : '0%'
                                                }
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot>
                                    <tr className="bg-gray-100 font-bold">
                                        <td className="border border-gray-200 p-3" colSpan="2">總計</td>
                                        <td className="border border-gray-200 p-3 text-center">
                                            {statistics.popularItems.reduce((sum, item) => sum + item.quantity, 0)}
                                        </td>
                                        <td className="border border-gray-200 p-3 text-right">${statistics.totalRevenue.toLocaleString()}</td>
                                        <td className="border border-gray-200 p-3 text-right">100%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {/* 累計數據 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div className="bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
                            <h3 className="text-lg font-bold mb-4">每日累計營業額</h3>
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {Object.entries(statistics.dailyData)
                                    .sort(([a], [b]) => new Date(b) - new Date(a))
                                    .map(([date, data]) => (
                                        <div key={date} className="flex justify-between items-center py-2 border-b border-gray-100">
                                            <span className="font-medium">{date}</span>
                                            <span className="text-green-600 font-bold">${data.revenue.toLocaleString()}</span>
                                        </div>
                                    ))
                                }
                            </div>
                        </div>

                        <div className="bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
                            <h3 className="text-lg font-bold mb-4">每日累計客數</h3>
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {Object.entries(statistics.dailyData)
                                    .sort(([a], [b]) => new Date(b) - new Date(a))
                                    .map(([date, data]) => (
                                        <div key={date} className="flex justify-between items-center py-2 border-b border-gray-100">
                                            <span className="font-medium">{date}</span>
                                            <span className="text-blue-600 font-bold">{data.customers} 人</span>
                                        </div>
                                    ))
                                }
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 訂單卡片組件
        const OrderCard = ({ order, onConfirm, onStatusUpdate, onPrint }) => {
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [adminNotes, setAdminNotes] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);

            const formatDate = (dateString) => {
                try {
                    if (!dateString) return '未設定';
                    const date = new Date(dateString);
                    return isNaN(date.getTime()) ? dateString : date.toLocaleString('zh-TW');
                } catch {
                    return dateString || '未設定';
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'confirmed': return 'bg-green-100 text-green-800 border-green-300';
                    case 'preparing': return 'bg-blue-100 text-blue-800 border-blue-300';
                    case 'ready': return 'bg-purple-100 text-purple-800 border-purple-300';
                    case 'completed': return 'bg-gray-100 text-gray-800 border-gray-300';
                    case 'cancelled': return 'bg-red-100 text-red-800 border-red-300';
                    case 'pending': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
                    default: return 'bg-gray-100 text-gray-800 border-gray-300';
                }
            };

            const getStatusText = (status) => {
                switch (status) {
                    case 'confirmed': return '已確認';
                    case 'preparing': return '製作中';
                    case 'ready': return '可取餐';
                    case 'completed': return '已完成';
                    case 'cancelled': return '已取消';
                    case 'pending': return '待確認';
                    default: return status || '未知';
                }
            };

            const handleConfirm = async () => {
                if (isProcessing) return;
                setIsProcessing(true);
                try {
                    await onConfirm(order.orderId, adminNotes);
                    setShowConfirmModal(false);
                    setAdminNotes('');
                } catch (error) {
                    console.error('確認訂單失敗:', error);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleStatusUpdate = async (newStatus) => {
                if (isProcessing) return;
                setIsProcessing(true);
                try {
                    await onStatusUpdate(order.orderId, newStatus);
                } catch (error) {
                    console.error('更新狀態失敗:', error);
                } finally {
                    setIsProcessing(false);
                }
            };

            const statusOptions = [
                { value: 'pending', label: '待確認', color: 'yellow' },
                { value: 'confirmed', label: '已確認', color: 'green' },
                { value: 'preparing', label: '製作中', color: 'blue' },
                { value: 'ready', label: '可取餐', color: 'purple' },
                { value: 'completed', label: '已完成', color: 'gray' },
                { value: 'cancelled', label: '已取消', color: 'red' }
            ];

            return (
                <div className="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden animate-fade-in">
                    {/* 訂單標頭 */}
                    <div className="bg-gray-50 px-4 py-3 border-b border-gray-200">
                        <div className="flex justify-between items-start">
                            <div className="flex-1">
                                <h3 className="font-bold text-lg break-words">{order.orderId || '未指定訂單編號'}</h3>
                                <p className="text-sm text-gray-600 mt-1">
                                    {order.customerName || '未提供姓名'} • {order.customerPhone || '未提供電話'}
                                </p>
                            </div>
                            <div className="text-right ml-4">
                                <span className={`px-3 py-1 rounded-full text-sm font-medium border ${getStatusColor(order.status)}`}>
                                    {getStatusText(order.status)}
                                </span>
                                <p className="text-sm text-gray-500 mt-1">
                                    {formatDate(order.createdAt)}
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* 訂單內容 */}
                    <div className="p-4">
                        <div className="mb-4">
                            <h4 className="font-semibold mb-2">訂單內容:</h4>
                            <div className="bg-gray-50 rounded-lg p-3">
                                <div className="space-y-2">
                                    {order.items.map((item, index) => (
                                        <div key={index} className="flex justify-between text-sm">
                                            <span className="flex-1">
                                                {item.icon} {item.name} 
                                                <span className="text-gray-500 ml-2">x{item.quantity}</span>
                                            </span>
                                            <span className="ml-4">
                                                ${item.price * item.quantity}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                                <div className="border-t mt-2 pt-2 font-bold">
                                    <div className="flex justify-between">
                                        <span>總金額:</span>
                                        <span>${order.totalAmount}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                            <div>
                                <p><strong>取餐時間:</strong> {formatDate(order.pickupTime)}</p>
                                <p><strong>取餐方式:</strong> {order.deliveryAddress ? '外送' : '自取'}</p>
                                {order.deliveryAddress && (
                                    <p className="break-words"><strong>外送地址:</strong> {order.deliveryAddress}</p>
                                )}
                            </div>
                            <div>
                                <p><strong>總金額:</strong> <span className="text-green-600 font-bold">${order.totalAmount}</span></p>
                                {order.notes && (
                                    <p className="break-words"><strong>顧客備註:</strong> {order.notes}</p>
                                )}
                            </div>
                        </div>

                        {order.adminNotes && (
                            <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                                <p className="text-sm text-yellow-800 break-words">
                                    <strong>店家備註:</strong> {order.adminNotes}
                                </p>
                            </div>
                        )}

                        {/* 操作按鈕 */}
                        <div className="flex flex-wrap gap-2">
                            {order.status === 'pending' && (
                                <button
                                    onClick={() => setShowConfirmModal(true)}
                                    disabled={isProcessing}
                                    className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
                                >
                                    {isProcessing ? <LoadingSpinner /> : '✅'}
                                    確認訂單
                                </button>
                            )}
                            
                            <select
                                value={order.status || 'pending'}
                                onChange={(e) => handleStatusUpdate(e.target.value)}
                                disabled={isProcessing}
                                className="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
                            >
                                {statusOptions.map(option => (
                                    <option key={option.value} value={option.value}>
                                        {option.label}
                                    </option>
                                ))}
                            </select>

                            <button
                                onClick={() => onPrint(order)}
                                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
                            >
                                🖨️ 列印
                            </button>
                        </div>
                    </div>

                    {/* 確認訂單模態框 */}
                    {showConfirmModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full animate-fade-in">
                                <h3 className="text-lg font-bold mb-4">確認訂單</h3>
                                <p className="mb-4">您即將確認訂單 <strong>{order.orderId}</strong></p>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        店家備註 (可選)
                                    </label>
                                    <textarea
                                        value={adminNotes}
                                        onChange={(e) => setAdminNotes(e.target.value)}
                                        rows="3"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        placeholder="輸入備註資訊..."
                                    />
                                </div>

                                <div className="flex justify-end gap-3">
                                    <button
                                        onClick={() => setShowConfirmModal(false)}
                                        disabled={isProcessing}
                                        className="px-4 py-2 text-gray-600 hover:text-gray-800 disabled:opacity-50"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={handleConfirm}
                                        disabled={isProcessing}
                                        className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
                                    >
                                        {isProcessing ? <LoadingSpinner /> : null}
                                        確認訂單
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 主應用組件
        const App = () => {
            const [orders, setOrders] = useState([]);
            const [filteredOrders, setFilteredOrders] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const [notification, setNotification] = useState({ message: '', type: 'success', visible: false });
            const [statusFilter, setStatusFilter] = useState('all');
            const [currentView, setCurrentView] = useState('orders');

            // 載入訂單
            const loadOrders = async () => {
                try {
                    const result = await apiService.getAllOrders();
                    if (result.success) {
                        setOrders(result.data);
                        applyFilters(result.data, statusFilter);
                        showNotification(`成功載入 ${result.data.length} 筆訂單`, 'success');
                    } else {
                        throw new Error(result.message || '載入訂單失敗');
                    }
                } catch (error) {
                    console.error('載入訂單失敗:', error);
                    showNotification('載入訂單失敗: ' + error.message, 'error');
                } finally {
                    setIsLoading(false);
                    setIsRefreshing(false);
                }
            };

            // 應用篩選
            const applyFilters = (ordersList, filter) => {
                if (filter === 'all') {
                    setFilteredOrders(ordersList);
                } else {
                    setFilteredOrders(ordersList.filter(order => order.status === filter));
                }
            };

            useEffect(() => {
                loadOrders();
            }, []);

            useEffect(() => {
                applyFilters(orders, statusFilter);
            }, [statusFilter, orders]);

            const showNotification = useCallback((message, type = 'success', duration = 4000) => {
                setNotification({ message, type, visible: true });
                setTimeout(() => setNotification(prev => ({ ...prev, visible: false })), duration);
            }, []);

            // 確認訂單
            const handleConfirmOrder = async (orderId, adminNotes) => {
                try {
                    const result = await apiService.confirmOrder(orderId, adminNotes);
                    if (result.success) {
                        showNotification('訂單已確認！', 'success');
                        await loadOrders();
                    } else {
                        throw new Error(result.message || '確認訂單失敗');
                    }
                } catch (error) {
                    console.error('確認訂單失敗:', error);
                    showNotification('確認訂單失敗: ' + error.message, 'error');
                    throw error;
                }
            };

            // 更新訂單狀態
            const handleStatusUpdate = async (orderId, status) => {
                try {
                    const result = await apiService.updateOrderStatus(orderId, status);
                    if (result.success) {
                        showNotification('訂單狀態已更新！', 'success');
                        await loadOrders();
                    } else {
                        throw new Error(result.message || '更新狀態失敗');
                    }
                } catch (error) {
                    console.error('更新狀態失敗:', error);
                    showNotification('更新狀態失敗: ' + error.message, 'error');
                    throw error;
                }
            };

            // 狀態篩選選項
            const statusFilters = [
                { value: 'all', label: '全部訂單', count: orders.length },
                { value: 'pending', label: '待確認', count: orders.filter(o => o.status === 'pending').length },
                { value: 'confirmed', label: '已確認', count: orders.filter(o => o.status === 'confirmed').length },
                { value: 'preparing', label: '製作中', count: orders.filter(o => o.status === 'preparing').length },
                { value: 'ready', label: '可取餐', count: orders.filter(o => o.status === 'ready').length },
                { value: 'completed', label: '已完成', count: orders.filter(o => o.status === 'completed').length },
                { value: 'cancelled', label: '已取消', count: orders.filter(o => o.status === 'cancelled').length }
            ];

            // 渲染當前視圖
            const renderCurrentView = () => {
                if (currentView === 'statistics') {
                    return <SalesStatistics orders={orders} currentView={currentView} onViewChange={setCurrentView} />;
                }

                return (
                    <div className="animate-fade-in">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">訂單管理</h2>
                            <button
                                onClick={() => setCurrentView('statistics')}
                                className="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors"
                            >
                                📊 查看銷售統計
                            </button>
                        </div>

                        {/* 控制面板 */}
                        <div className="bg-white rounded-lg p-4 border border-gray-200 shadow-sm mb-6">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div className="flex flex-wrap gap-2">
                                    {statusFilters.map(filter => (
                                        <button
                                            key={filter.value}
                                            onClick={() => setStatusFilter(filter.value)}
                                            className={`px-4 py-2 rounded-lg border transition-colors ${
                                                statusFilter === filter.value
                                                    ? 'bg-blue-500 text-white border-blue-500'
                                                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                                            }`}
                                        >
                                            {filter.label} ({filter.count})
                                        </button>
                                    ))}
                                </div>
                                
                                <button
                                    onClick={loadOrders}
                                    disabled={isRefreshing}
                                    className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
                                >
                                    {isRefreshing ? <LoadingSpinner /> : '🔄'}
                                    {isRefreshing ? '刷新中...' : '刷新訂單'}
                                </button>
                            </div>
                        </div>

                        {/* 訂單列表 */}
                        {isLoading ? (
                            <div className="text-center py-12">
                                <LoadingSpinner />
                                <p className="mt-4 text-gray-600">載入訂單中...</p>
                            </div>
                        ) : filteredOrders.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="text-4xl mb-4">📋</div>
                                <p className="text-gray-500 text-lg">暫無訂單</p>
                                <p className="text-gray-400">
                                    {statusFilter !== 'all' 
                                        ? `目前沒有${statusFilters.find(f => f.value === statusFilter)?.label}的訂單`
                                        : '尚未收到任何訂單'}
                                </p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                {filteredOrders.map((order, index) => (
                                    <OrderCard
                                        key={order.orderId || index}
                                        order={order}
                                        onConfirm={handleConfirmOrder}
                                        onStatusUpdate={handleStatusUpdate}
                                        onPrint={(order) => window.print()}
                                    />
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="container mx-auto px-4 py-6 max-w-7xl">
                        {/* 標頭 */}
                        <div className="mb-8">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">台灣小吃店 - 店家管理系統</h1>
                            <p className="text-gray-600">
                                {currentView === 'orders' ? '訂單管理與追蹤' : '銷售統計與分析'}
                            </p>
                        </div>

                        {renderCurrentView()}
                    </div>

                    <Notification
                        message={notification.message}
                        type={notification.type}
                        visible={notification.visible}
                        onClose={() => setNotification(prev => ({ ...prev, visible: false }))}
                    />
                </div>
            );
        };

        // 渲染應用
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
