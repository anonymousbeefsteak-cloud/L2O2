import type { MenuItem, OrderPayload, OrderResult, ApiError } from '../types';
import { API_ENDPOINT, API_KEY, SOURCE, REQUEST_TIMEOUT } from '../constants';

const apiCall = async <T,>(payload: object): Promise<T> => {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            // To prevent CORS preflight issues with Google Apps Script, we send the data
            // as text/plain by not setting the Content-Type header. The backend script
            // is configured to parse the plain text body as JSON.
            body: JSON.stringify(payload),
            signal: controller.signal,
        });
        
        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            return result.data as T;
        } else {
            throw { message: result.message, code: result.code || 'UNKNOWN_ERROR' } as ApiError;
        }
    } catch (error) {
        clearTimeout(timeoutId);
        if ((error as Error).name === 'AbortError') {
             throw { message: '請求超時，請檢查您的網路連線', code: 'TIMEOUT' } as ApiError;
        }
        console.error('API Call Failed:', error);
        throw error as ApiError;
    }
};

export const testConnection = async (): Promise<boolean> => {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

    try {
        const payload: { [key: string]: string } = {
            action: 'test',
            apiKey: API_KEY,
            source: SOURCE,
            userAgent: navigator.userAgent
        };
        
        const url = new URL(API_ENDPOINT);
        Object.keys(payload).forEach(key => url.searchParams.append(key, payload[key]));
        
        const response = await fetch(url.toString(), {
            method: 'POST',
            // No body, data is in URL params. This avoids redirect issues with POST bodies.
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        if (!response.ok) {
            console.error("Connection test response was not ok:", response.status, response.statusText);
            return false;
        }

        const result = await response.json();
        return result.success === true;

    } catch (error) {
        clearTimeout(timeoutId);
        console.error("Connection test failed:", error);
        return false;
    }
};

export const fetchMenu = async (): Promise<MenuItem[]> => {
    return apiCall<MenuItem[]>({
        action: 'getMenu',
        apiKey: API_KEY,
        source: SOURCE,
    });
};

export const submitOrder = async (orderData: OrderPayload): Promise<OrderResult> => {
    return apiCall<OrderResult>({
        action: 'createOrder',
        apiKey: API_KEY,
        source: SOURCE,
        userAgent: navigator.userAgent,
        orderData: orderData
    });
};
