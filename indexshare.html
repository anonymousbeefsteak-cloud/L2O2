<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>台灣小吃店 - 線上訂餐與查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
      /* Custom scrollbar to match theme */
      ::-webkit-scrollbar {
          width: 8px;
      }
      ::-webkit-scrollbar-track {
          background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
          background: #e74c3c;
          border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
          background: #c0392b;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.25.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
<!-- Babel for in-browser JSX transformation -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
// All application code is consolidated here.
// Imports will work due to the importmap and data-type="module".
import React, { useState, useCallback, useMemo, useEffect } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI, Type } from "@google/genai";

// --- START: types.ts (as constants/comments) ---
const OrderStatus = {
    Pending: 'pending',
    Confirmed: 'confirmed',
    Completed: 'completed',
    Cancelled: 'cancelled',
};

// --- START: services/geminiService.ts ---
if (!process.env.API_KEY) {
  console.error("API_KEY environment variable not set. This app requires the execution environment to provide process.env.API_KEY.");
  // Display a user-friendly message in the UI
  document.getElementById('root').innerHTML = `
    <div style="padding: 2rem; text-align: center; font-family: sans-serif;">
      <h1 style="color: #c0392b; font-size: 1.5rem;">設定錯誤</h1>
      <p style="color: #333;">應用程式缺少必要的 API 金鑰設定，無法啟動。</p>
    </div>
  `;
  throw new Error("API_KEY not configured.");
}

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const orderItemSchema = {
    type: Type.OBJECT,
    properties: {
        name: { type: Type.STRING, description: "Name of the food item, in Traditional Chinese." },
        quantity: { type: Type.INTEGER, description: "Quantity of the item." },
        price: { type: Type.NUMBER, description: "Price per single item." },
    },
    required: ["name", "quantity", "price"],
};

const orderSchema = {
    type: Type.OBJECT,
    properties: {
        orderId: { type: Type.STRING, description: "A unique order ID, e.g., 'TW' followed by current date and a 3-digit serial number like 'TW20240521001'." },
        createdAt: { type: Type.STRING, description: "Order creation timestamp in ISO 8601 format. Should be the current time." },
        status: { type: Type.STRING, enum: ['pending', 'confirmed', 'completed', 'cancelled'], description: "The initial status should always be 'pending'." },
        items: { type: Type.ARRAY, items: orderItemSchema },
        subtotal: { type: Type.NUMBER, description: "The total price of all items before fees. YOU MUST CALCULATE THIS based on items." },
        deliveryFee: { type: Type.NUMBER, description: "Delivery fee. YOU MUST CALCULATE THIS based on the provided rules." },
        totalAmount: { type: Type.NUMBER, description: "The final total amount (subtotal + deliveryFee). YOU MUST CALCULATE THIS." },
        deliveryAddress: { type: Type.STRING, description: "Delivery address. Null if self-pickup.", nullable: true },
        pickupTime: { type: Type.STRING, description: "Scheduled pickup time in ISO 8601 format. Set to 30 minutes from now.", nullable: true },
        notes: { type: Type.STRING, description: "Customer notes for the order.", nullable: true },
    },
    required: ["orderId", "createdAt", "status", "items", "subtotal", "deliveryFee", "totalAmount"],
};

const queryResponseSchema = {
    type: Type.ARRAY,
    items: orderSchema,
};

const fetchOrders = async (params) => {
    const { phone, startDate, endDate, searchAll } = params;

    let dateInstruction = '';
    if (!searchAll && startDate && endDate) {
        dateInstruction = `The order's 'createdAt' date must be between ${startDate} and ${endDate}.`;
    } else {
        dateInstruction = `The order's 'createdAt' date can be any time in the past year.`;
    }
    
    const prompt = `
        You are a backend API for a fictional but realistic Taiwanese snack shop (台灣小吃店).
        A customer with phone number "${phone}" is requesting their order history.
        Generate a realistic but fictional list of 0 to 5 orders matching this request.
        The list should be in JSON format, strictly adhering to the provided schema.

        RULES:
        1.  ${dateInstruction}
        2.  Generate common Taiwanese snack items like 滷肉飯 (Braised Pork Rice), 蚵仔煎 (Oyster Omellete), 鹽酥雞 (Salt and Pepper Chicken), 珍珠奶茶 (Bubble Tea), 牛肉麵 (Beef Noodle Soup).
        3.  If you generate 0 orders, return an empty array [].
        4.  Sort the orders by 'createdAt' in descending order (newest first).
        5.  Ensure 'subtotal', 'deliveryFee', and 'totalAmount' are calculated correctly. Delivery fee is usually 30, or 0 if total is over 200.
        6.  The response must be only the JSON array, with no other text or explanations.
    `;

    try {
        const response = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
            config: {
                responseMimeType: "application/json",
                responseSchema: queryResponseSchema,
            },
        });
        
        const jsonText = response.text.trim();
        if (!jsonText) {
             return [];
        }
        
        const data = JSON.parse(jsonText);
        // Ensure data is an array
        return Array.isArray(data) ? data : [];

    } catch (error) {
        console.error("Error fetching or parsing orders from Gemini API:", error);
        throw new Error("Could not retrieve order information. The AI service may be temporarily unavailable.");
    }
};

const createOrder = async (
    items,
    customerInfo,
    config
) => {
    
    const itemsJsonString = JSON.stringify(items);
    const deliveryInfo = customerInfo.address 
        ? `This is a delivery order to "${customerInfo.address}".` 
        : "This is a self-pickup order.";

    const prompt = `
        You are a secure backend order processing system for a Taiwanese snack shop.
        A customer named "${customerInfo.name}" with phone "${customerInfo.phone}" is placing a new order.
        
        The items in the cart are:
        ${itemsJsonString}

        ${deliveryInfo}
        The customer's notes are: "${customerInfo.notes}"

        Your task is to:
        1.  Act as a server. Generate a single, complete order JSON object.
        2.  The response MUST strictly follow the provided JSON schema.
        3.  Generate a new unique 'orderId' (e.g., TW + date + 3 digits).
        4.  Set 'createdAt' to the current ISO 8601 timestamp.
        5.  Set 'status' to 'pending'.
        6.  Set 'pickupTime' to 30 minutes from now in ISO 8601 format.
        7.  **IMPORTANT: You MUST calculate 'subtotal', 'deliveryFee', and 'totalAmount' yourself based on the items and these rules:**
            - 'subtotal' is the sum of (price * quantity) for all items.
            - 'deliveryFee' is ${config.DELIVERY_FEE} if it's a delivery order AND subtotal is less than ${config.FREE_DELIVERY_THRESHOLD}. Otherwise, 'deliveryFee' is 0.
            - 'totalAmount' is subtotal + deliveryFee.
        8.  The final output must be ONLY the single JSON object, nothing else.
    `;

     try {
        const response = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
            config: {
                responseMimeType: "application/json",
                responseSchema: orderSchema,
            },
        });
        
        const jsonText = response.text.trim();
        const data = JSON.parse(jsonText);
        return data;

    } catch (error) {
        console.error("Error creating order with Gemini API:", error);
        throw new Error("Could not create the order. The AI service may be temporarily unavailable.");
    }
};

// --- START: components/Alert.tsx ---
const alertConfig = {
    success: { bg: 'bg-green-100', border: 'border-green-400', text: 'text-green-800', icon: 'fas fa-check-circle', },
    danger: { bg: 'bg-red-100', border: 'border-red-400', text: 'text-red-800', icon: 'fas fa-exclamation-circle', },
    warning: { bg: 'bg-yellow-100', border: 'border-yellow-400', text: 'text-yellow-800', icon: 'fas fa-exclamation-triangle', },
    info: { bg: 'bg-blue-100', border: 'border-blue-400', text: 'text-blue-800', icon: 'fas fa-info-circle', },
};

const Alert = ({ message, type }) => {
    const config = alertConfig[type];
    return (
        <div className={`p-4 mb-4 border-l-4 rounded-r-lg ${config.bg} ${config.border} ${config.text}`} role="alert">
            <div className="flex">
                <div className="py-1"><i className={`${config.icon} mr-3`}></i></div>
                <div><p className="font-bold">{message}</p></div>
            </div>
        </div>
    );
};


// --- START: components/Footer.tsx ---
const Footer = () => {
    return (
        <footer className="bg-gray-800 text-white pt-8 pb-6">
            <div className="container mx-auto px-4">
                <div className="flex flex-wrap text-center md:text-left">
                    <div className="w-full md:w-1/3 px-4 mb-8 md:mb-0">
                        <h3 className="text-lg font-semibold mb-4">台灣小吃店</h3>
                        <p className="text-gray-400">最道地的台灣傳統美食</p>
                    </div>
                    <div className="w-full md:w-1/3 px-4 mb-8 md:mb-0">
                        <h3 className="text-lg font-semibold mb-4">聯絡我們</h3>
                        <ul className="text-gray-400 space-y-2">
                            <li><i className="fas fa-phone mr-2"></i> (02) 2368-8999</li>
                            <li><i className="fas fa-map-marker-alt mr-2"></i> 台北市大安區羅斯福路三段XXX號</li>
                            <li><i className="fas fa-clock mr-2"></i> 10:00 - 21:00</li>
                        </ul>
                    </div>
                    <div className="w-full md:w-1/3 px-4">
                        <h3 className="text-lg font-semibold mb-4">訂餐說明</h3>
                        <ul className="text-gray-400 space-y-2">
                            <li>營業時間: 10:00-21:00</li>
                            <li>外送費用: $30 (滿$200免運)</li>
                            <li>支援線上訂餐與查詢</li>
                        </ul>
                    </div>
                </div>
                <hr className="my-6 border-gray-700" />
                <div className="text-center text-gray-500 text-sm">
                    &copy; {new Date().getFullYear()} 台灣小吃店 版權所有 | 訂單查詢系統
                </div>
            </div>
        </footer>
    );
};

// --- START: components/Header.tsx ---
const Header = ({ onNavigate, activeView, cartItemCount }) => {
    const getLinkClasses = (view) => {
        const baseClasses = "px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 cursor-pointer relative";
        if (view === activeView) {
            return `${baseClasses} bg-white text-red-700 shadow-inner`;
        }
        return `${baseClasses} text-white hover:bg-red-700`;
    };
    
    return (
        <header className="bg-gradient-to-r from-red-600 to-red-800 text-white p-4 shadow-lg sticky top-0 z-10">
            <div className="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                <div className="flex items-center gap-3 mb-2 sm:mb-0 cursor-pointer" onClick={() => onNavigate('menu')}>
                    <i className="fas fa-utensils text-2xl"></i>
                    <div>
                      <h1 className="text-2xl font-bold">台灣小吃店</h1>
                      <p className="text-xs opacity-90 hidden sm:block">線上訂餐與查詢系統</p>
                    </div>
                </div>
                <nav className="bg-red-800/50 p-1 rounded-lg">
                    <ul className="flex items-center space-x-2">
                        <li>
                            <a onClick={() => onNavigate('menu')} className={getLinkClasses('menu')}>
                                <i className="fas fa-utensils mr-1 sm:mr-2"></i>點餐
                            </a>
                        </li>
                        <li>
                            <a onClick={() => onNavigate('cart')} className={getLinkClasses('cart')}>
                                <i className="fas fa-shopping-cart mr-1 sm:mr-2"></i>購物車
                                {cartItemCount > 0 && (
                                    <span className="absolute -top-2 -right-2 bg-yellow-400 text-red-800 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                                        {cartItemCount}
                                    </span>
                                )}
                            </a>
                        </li>
                         <li>
                            <a onClick={() => onNavigate('lookup')} className={getLinkClasses('lookup')}>
                                <i className="fas fa-search mr-1 sm:mr-2"></i>查詢訂單
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>
    );
};

// --- START: components/OrderCard.tsx ---
const SECURITY_CONFIG_CARD = { SECRET: 'TW_SNACK_2023_SECRET', };

const generateApiKey = (phone) => {
    const timestamp = new Date().getTime();
    const data = `${phone}:${timestamp}:${SECURITY_CONFIG_CARD.SECRET}`;
    const key = btoa(unescape(encodeURIComponent(data)));
    return { apiKey: key, timestamp: timestamp.toString() };
};

const statusConfig = {
    [OrderStatus.Pending]: { text: '待確認', classes: 'bg-yellow-100 text-yellow-800' },
    [OrderStatus.Confirmed]: { text: '已確認', classes: 'bg-blue-100 text-blue-800' },
    [OrderStatus.Completed]: { text: '已完成', classes: 'bg-green-100 text-green-800' },
    [OrderStatus.Cancelled]: { text: '已取消', classes: 'bg-red-100 text-red-800' },
};

const DetailItem = ({ label, value }) => {
    if (!value) return null;
    return (
        <div className="flex justify-between items-start text-sm">
            <span className="text-gray-500">{label}:</span>
            <span className="font-medium text-gray-800 text-right">{value}</span>
        </div>
    );
};

const OrderCard = ({ order, phone }) => {
    const { orderId, createdAt, status, items, subtotal, deliveryFee, totalAmount, deliveryAddress, pickupTime, notes } = order;
    
    const config = statusConfig[status] || statusConfig[OrderStatus.Pending];
    const formattedDate = new Date(createdAt).toLocaleString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    const formattedPickupTime = pickupTime ? new Date(pickupTime).toLocaleString('zh-TW') : undefined;

    const itemsText = items.map(item => `${item.name} x${item.quantity}`).join(', ');
    const itemsForShare = items.map(item => `  - ${item.name} x ${item.quantity}`).join('\\n');
    const deliveryType = deliveryFee > 0 ? '外送' : '自取';
    const deliveryInfo = deliveryFee > 0 ? deliveryAddress : '店面自取';

    const handleShare = () => {
        const messageParts = [
            '🏮 台灣小吃店 - 訂單確認 🏮','',
            `訂單編號: ${orderId}`,'',
            '【訂單內容】', itemsForShare, '',
            `總金額: $${totalAmount}`,'',
            `取餐方式: ${deliveryType}`,
        ];
        if (deliveryAddress) messageParts.push(`外送地址: ${deliveryAddress}`);
        if (formattedPickupTime) messageParts.push(`預計時間: ${formattedPickupTime}`);
        messageParts.push('', '感謝您的訂購！');
        
        const message = messageParts.join('\\n');
        const { apiKey, timestamp } = generateApiKey(phone);
        const params = new URLSearchParams({ text: message, apiKey: apiKey, timestamp: timestamp, });
        const shareUrl = `https://script.google.com/macros/s/AKfycbxHc09JzpyEFP48MAykDdcc0d2_doU2RnwJlmlicJOw19Kan2OeMrp0a0CFmeSlwUmu/exec?${params.toString()}`;
        window.open(shareUrl, '_blank', 'noopener,noreferrer');
    };

    return (
        <div className="bg-white border-l-4 border-red-600 rounded-r-lg shadow-md overflow-hidden">
            <div className="p-4">
                <div className="flex justify-between items-center mb-3">
                    <h3 className="font-bold text-gray-800">訂單編號: {orderId}</h3>
                    <span className={`px-3 py-1 text-xs font-semibold rounded-full ${config.classes}`}>{config.text}</span>
                </div>
                <div className="space-y-2 mb-4">
                    <DetailItem label="下單時間" value={formattedDate} />
                    <DetailItem label="訂單項目" value={itemsText} />
                    <DetailItem label="取餐方式" value={`${deliveryType} (${deliveryInfo})`} />
                    <DetailItem label="預定取餐" value={formattedPickupTime} />
                    <DetailItem label="備註" value={notes} />
                </div>
                <div className="bg-gray-50 p-3 rounded-md border border-gray-200">
                    <div className="space-y-1">
                       <div className="flex justify-between text-sm"><span>小計:</span><span>${subtotal}</span></div>
                       {deliveryFee > 0 && (<div className="flex justify-between text-sm"><span>外送費:</span><span>${deliveryFee}</span></div>)}
                       <div className="flex justify-between font-bold text-base text-red-700 pt-1 border-t border-gray-200 mt-1"><span>總計:</span><span>${totalAmount}</span></div>
                    </div>
                </div>
                <div className="mt-4 flex justify-end">
                    <button onClick={handleShare} className="inline-flex items-center gap-2 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition-colors duration-200" aria-label="分享訂單到 LINE">
                        <i className="fab fa-line text-lg"></i><span>分享訂單到 LINE</span>
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- START: components/OrderResults.tsx ---
const OrderResults = ({ orders, phone, onNewQuery }) => {
    return (
        <div className="bg-white rounded-lg p-6 md:p-8 shadow-lg max-w-4xl mx-auto">
            <div className="text-center mb-6">
                <i className="fas fa-clipboard-list text-5xl text-red-600 mb-4"></i>
                <h2 className="text-2xl font-bold mb-2">訂單查詢結果</h2>
                <p className="text-gray-600">手機號碼 <span className="font-semibold text-gray-800">{phone}</span> 的訂單記錄</p>
            </div>
            {orders.length > 0 ? (
                <div className="space-y-4">
                    {orders.map((order) => (<OrderCard key={order.orderId} order={order} phone={phone} />))}
                </div>
            ) : (
                <div className="text-center py-10 px-6 bg-gray-50 rounded-lg">
                    <i className="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
                    <h3 className="text-xl font-semibold text-gray-700 mb-2">沒有找到訂單記錄</h3>
                    <p className="text-gray-500">請確認查詢條件是否正確，或您還沒有下過訂單。</p>
                </div>
            )}
            <div className="mt-8 text-center">
                 <button onClick={onNewQuery} className="px-6 py-2 border border-red-600 text-red-600 font-medium rounded-md hover:bg-red-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                    <i className="fas fa-search mr-2"></i>查詢其他號碼
                </button>
            </div>
        </div>
    );
};

// --- START: components/QueryForm.tsx ---
const getDefaultDateRange = () => {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - 30);
    return { start: startDate.toISOString().split('T')[0], end: endDate.toISOString().split('T')[0] };
};

const QueryForm = ({ onQuery, isLoading, initialError }) => {
    const [phone, setPhone] = useState('');
    const [error, setError] = useState(null);
    const [startDate, setStartDate] = useState(getDefaultDateRange().start);
    const [endDate, setEndDate] = useState(getDefaultDateRange().end);
    const [searchAll, setSearchAll] = useState(false);

    useEffect(() => { setError(initialError); }, [initialError]);
    
    useEffect(() => {
        const lastPhone = localStorage.getItem('lastSearchedPhone');
        if (lastPhone) setPhone(lastPhone);
    }, []);

    const handleSubmit = (e) => {
        e.preventDefault();
        setError(null);
        if (!/^(09\d{8}|9\d{8})$/.test(phone)) {
            setError('請填寫有效的手機號碼 (例如: 0912345678)');
            return;
        }
        if (!searchAll && new Date(startDate) > new Date(endDate)) {
            setError('開始日期不能晚於結束日期');
            return;
        }
        localStorage.setItem('lastSearchedPhone', phone);
        onQuery({ phone, startDate: searchAll ? undefined : startDate, endDate: searchAll ? undefined : endDate, searchAll });
    };

    return (
        <div className="bg-white rounded-lg p-6 md:p-8 shadow-lg max-w-2xl mx-auto">
            <div className="text-center">
                <i className="fas fa-mobile-alt text-5xl text-red-600 mb-4"></i>
                <h2 className="text-2xl font-bold mb-2">訂單查詢</h2>
                <p className="text-gray-600 mb-6">請輸入您的手機號碼與查詢範圍</p>
            </div>
            {error && <Alert message={error} type="danger" />}
            <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                    <label htmlFor="customer-phone" className="block text-sm font-medium text-gray-700 mb-1">手機號碼</label>
                    <input type="tel" id="customer-phone" className="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"
                        placeholder="請輸入您的手機號碼 (09開頭)" maxLength={10} required value={phone} onChange={(e) => setPhone(e.target.value.replace(/\D/g, ''))}/>
                </div>
                <div className="flex items-center space-x-4">
                    <div className="flex-1">
                        <label htmlFor="start-date" className="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                        <input type="date" id="start-date" className="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 disabled:bg-gray-100"
                            value={startDate} onChange={e => setStartDate(e.target.value)} disabled={searchAll || isLoading} />
                    </div>
                    <div className="flex-1">
                        <label htmlFor="end-date" className="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                        <input type="date" id="end-date" className="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 disabled:bg-gray-100"
                            value={endDate} onChange={e => setEndDate(e.target.value)} disabled={searchAll || isLoading} />
                    </div>
                </div>
                <div className="flex items-center">
                    <input id="search-all" name="search-all" type="checkbox" checked={searchAll} onChange={(e) => setSearchAll(e.target.checked)} disabled={isLoading}
                      className="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded" />
                    <label htmlFor="search-all" className="ml-2 block text-sm text-gray-900">查詢此號碼的所有訂單</label>
                </div>
                <button type="submit" className="w-full flex justify-center items-center gap-2 px-4 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-red-300"
                    disabled={isLoading}>
                    {isLoading ? (<><i className="fas fa-spinner fa-spin"></i> 查詢中...</>) : (<><i className="fas fa-search"></i> 查詢我的訂單</>)}
                </button>
            </form>
        </div>
    );
};

// --- START: components/StepIndicator.tsx ---
const Step = ({ number, label, isActive, isCompleted }) => {
    const numberClasses = `w-10 h-10 rounded-full flex items-center justify-center font-bold border-2 border-white transition-colors duration-300
        ${isCompleted ? 'bg-green-500 text-white' : ''}
        ${isActive ? 'bg-red-600 text-white' : ''}
        ${!isActive && !isCompleted ? 'bg-gray-200 text-gray-600' : ''}
    `;
    const labelClasses = `text-sm mt-2 text-center transition-colors duration-300
        ${isActive ? 'text-red-600 font-semibold' : 'text-gray-500'}
    `;
    return (
        <div className="flex flex-col items-center">
            <div className={numberClasses}>{isCompleted ? <i className="fas fa-check"></i> : number}</div>
            <div className={labelClasses}>{label}</div>
        </div>
    );
};

const StepIndicator = ({ currentStep }) => {
    const steps = [
        { number: 1, label: '輸入資料' }, { number: 2, label: '查詢訂單' }, { number: 3, label: '查看結果' },
    ];
    return (
        <div className="mb-8 flex justify-center items-start">
            <div className="relative w-full max-w-md">
                <div className="absolute top-5 left-0 w-full h-0.5 bg-gray-200"></div>
                <div className="absolute top-5 left-0 h-0.5 bg-red-600 transition-all duration-500" style={{ width: `${((currentStep - 1) / (steps.length - 1)) * 100}%` }}></div>
                <div className="relative flex justify-between">
                    {steps.map((step) => (
                        <Step key={step.number} number={step.number} label={step.label} isActive={currentStep === step.number} isCompleted={currentStep > step.number}/>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- START: App.tsx ---
const AppStep = { FORM: 1, QUERYING: 2, RESULTS: 3, };

const MENU_ITEMS = [
    { name: '滷肉飯', price: 50, icon: '🍚', quantity: 0, }, { name: '牛肉麵', price: 150, icon: '🍜', quantity: 0, },
    { name: '蚵仔煎', price: 70, icon: '🍳', quantity: 0, }, { name: '鹽酥雞', price: 60, icon: '🍗', quantity: 0, },
    { name: '珍珠奶茶', price: 50, icon: '🥤', quantity: 0, }, { name: '臭豆腐', price: 55, icon: '🧱', quantity: 0, },
    { name: '刈包', price: 65, icon: '🍔', quantity: 0, }, { name: '大腸麵線', price: 60, icon: '🍲', quantity: 0, },
];
const CONFIG_APP = { DELIVERY_FEE: 30, FREE_DELIVERY_THRESHOLD: 200, };

function App() {
    const [view, setView] = useState('menu');
    const [cart, setCart] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);
    const [lookupStep, setLookupStep] = useState(AppStep.FORM);
    const [orders, setOrders] = useState([]);
    const [currentPhone, setCurrentPhone] = useState('');

    const handleQuery = useCallback(async (params) => {
        setIsLoading(true);
        setError(null);
        setLookupStep(AppStep.QUERYING);
        setCurrentPhone(params.phone);
        try {
            const results = await fetchOrders(params);
            setOrders(results);
            setLookupStep(AppStep.RESULTS);
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
            setLookupStep(AppStep.FORM);
        } finally {
            setIsLoading(false);
        }
    }, []);

    const handleNewQuery = useCallback(() => {
        setLookupStep(AppStep.FORM);
        setOrders([]);
        setError(null);
        setCurrentPhone('');
    }, []);
    
    const navigate = (newView) => { setView(newView); setError(null); setSuccessMessage(null); };

    const handleAddToCart = (item) => {
        setCart(prevCart => {
            const existingItem = prevCart.find(cartItem => cartItem.name === item.name);
            if (existingItem) {
                return prevCart.map(cartItem => cartItem.name === item.name ? { ...cartItem, quantity: cartItem.quantity + 1 } : cartItem);
            }
            return [...prevCart, { ...item, quantity: 1 }];
        });
    };

    const handleUpdateQuantity = (itemName, quantity) => {
        if (quantity <= 0) {
            setCart(prevCart => prevCart.filter(item => item.name !== itemName));
        } else {
            setCart(prevCart => prevCart.map(item => item.name === itemName ? { ...item, quantity } : item));
        }
    };
    
    const handleCreateOrder = async (customerInfo) => {
        setIsLoading(true);
        setError(null);
        setSuccessMessage(null);
        try {
            const newOrder = await createOrder(cart, customerInfo, CONFIG_APP);
            setSuccessMessage(`訂單 ${newOrder.orderId} 已成功建立！`);
            setCart([]);
            setTimeout(() => {
                setView('lookup');
                setOrders([newOrder]);
                setCurrentPhone(customerInfo.phone);
                setLookupStep(AppStep.RESULTS);
            }, 1500);
        } catch (err) {
             setError(err instanceof Error ? err.message : '建立訂單時發生錯誤');
        } finally {
            setIsLoading(false);
        }
    };
    
    const cartItemCount = useMemo(() => cart.reduce((sum, item) => sum + item.quantity, 0), [cart]);

    const renderContent = () => {
        switch (view) {
            case 'menu': return <Menu onAddToCart={handleAddToCart} cart={cart} onUpdateQuantity={handleUpdateQuantity} />;
            case 'cart': return <Cart cart={cart} onUpdateQuantity={handleUpdateQuantity} isLoading={isLoading} onCreateOrder={handleCreateOrder} />;
            case 'lookup': return (
                <>
                    <StepIndicator currentStep={lookupStep} />
                    {lookupStep === AppStep.FORM || lookupStep === AppStep.QUERYING ? (
                        <QueryForm onQuery={handleQuery} isLoading={isLoading} initialError={error} />
                    ) : (
                        <OrderResults orders={orders} phone={currentPhone} onNewQuery={handleNewQuery} />
                    )}
                </>
            );
            default: return null;
        }
    };

    return (
        <div className="flex flex-col min-h-screen bg-gray-50 text-gray-800 font-sans">
            <Header onNavigate={navigate} activeView={view} cartItemCount={cartItemCount} />
            <main className="flex-grow container mx-auto px-4 py-8">
                {error && <Alert message={error} type="danger" />}
                {successMessage && <Alert message={successMessage} type="success" />}
                {renderContent()}
            </main>
            <Footer />
        </div>
    );
}

const Menu = ({ onAddToCart, cart, onUpdateQuantity }) => (
    <div className="max-w-5xl mx-auto">
        <div className="text-center mb-8">
             <i className="fas fa-utensils text-5xl text-red-600 mb-4"></i>
            <h2 className="text-3xl font-bold">美味菜單</h2>
            <p className="text-gray-600">選擇您喜愛的台灣小吃</p>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {MENU_ITEMS.map(item => {
                const cartItem = cart.find(ci => ci.name === item.name);
                const quantityInCart = cartItem?.quantity || 0;
                return (
                    <div key={item.name} className="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
                        <div className="text-6xl text-center py-6 bg-gray-100">{item.icon}</div>
                        <div className="p-4 flex flex-col flex-grow">
                            <h3 className="text-xl font-semibold mb-2">{item.name}</h3>
                            <p className="text-red-600 font-bold text-lg mb-4 mt-auto">${item.price}</p>
                            {quantityInCart === 0 ? (
                                <button onClick={() => onAddToCart(item)} className="w-full mt-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors flex items-center justify-center gap-2">
                                    <i className="fas fa-cart-plus"></i> 加入購物車
                                </button>
                            ) : (
                                <div className="flex items-center justify-center gap-2">
                                    <button onClick={() => onUpdateQuantity(item.name, quantityInCart - 1)} className="w-10 h-10 bg-gray-200 rounded-full hover:bg-gray-300">-</button>
                                    <span className="text-lg font-bold w-12 text-center">{quantityInCart}</span>
                                    <button onClick={() => onUpdateQuantity(item.name, quantityInCart + 1)} className="w-10 h-10 bg-gray-200 rounded-full hover:bg-gray-300">+</button>
                                </div>
                            )}
                        </div>
                    </div>
                )
            })}
        </div>
    </div>
);

const Cart = ({ cart, onUpdateQuantity, isLoading, onCreateOrder }) => {
    const [delivery, setDelivery] = useState(false);
    const [name, setName] = useState('');
    const [phone, setPhone] = useState('');
    const [address, setAddress] = useState('');
    const [notes, setNotes] = useState('');
    const [error, setError] = useState('');
    
    const subtotal = useMemo(() => cart.reduce((sum, item) => sum + item.price * item.quantity, 0), [cart]);
    const deliveryFee = delivery && subtotal < CONFIG_APP.FREE_DELIVERY_THRESHOLD ? CONFIG_APP.DELIVERY_FEE : 0;
    const total = subtotal + deliveryFee;

    const handleSubmit = () => {
        setError('');
        if (!name.trim()) { setError('請填寫姓名'); return; }
        if (!/^(09\d{8}|9\d{8})$/.test(phone.trim())) { setError('請填寫有效的手機號碼'); return; }
        if (delivery && !address.trim()) { setError('請填寫外送地址'); return; }
        onCreateOrder({ name, phone, address: delivery ? address : null, notes });
    };

    if (cart.length === 0) {
        return (
             <div className="text-center py-10 px-6 bg-white rounded-lg shadow-lg">
                <i className="fas fa-shopping-cart text-5xl text-gray-300 mb-4"></i>
                <h3 className="text-xl font-semibold text-gray-700 mb-2">您的購物車是空的</h3>
                <p className="text-gray-500">快去菜單頁面選購美食吧！</p>
            </div>
        );
    }
    
    return (
        <div className="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-2xl font-bold mb-4">您的購物車</h2>
                <div className="space-y-4">
                    {cart.map(item => (
                        <div key={item.name} className="flex items-center justify-between border-b pb-4">
                            <div>
                                <h3 className="font-semibold">{item.name}</h3>
                                <p className="text-gray-600">${item.price}</p>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => onUpdateQuantity(item.name, item.quantity - 1)} className="w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300">-</button>
                                <span className="font-bold w-8 text-center">{item.quantity}</span>
                                <button onClick={() => onUpdateQuantity(item.name, item.quantity + 1)} className="w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300">+</button>
                                <span className="w-20 text-right font-semibold">${item.price * item.quantity}</span>
                            </div>
                        </div>
                    ))}
                </div>
                 <div className="mt-6 bg-gray-50 p-4 rounded-lg">
                    <div className="flex justify-between text-lg"><span>小計</span><span>${subtotal}</span></div>
                    <div className="flex justify-between text-lg"><span>外送費</span><span>${deliveryFee}</span></div>
                    <div className="flex justify-between text-xl font-bold mt-2 pt-2 border-t"><span>總計</span><span>${total}</span></div>
                </div>
            </div>
            <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-2xl font-bold mb-4">訂單資訊</h2>
                {error && <Alert message={error} type="danger" />}
                <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">姓名</label>
                        <input type="text" value={name} onChange={e => setName(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" />
                    </div>
                     <div>
                        <label className="block text-sm font-medium text-gray-700">手機號碼</label>
                        <input type="tel" value={phone} onChange={e => setPhone(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" />
                    </div>
                    <div className="flex items-center">
                        <input type="checkbox" id="delivery" checked={delivery} onChange={e => setDelivery(e.target.checked)} className="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded" />
                        <label htmlFor="delivery" className="ml-2 block text-sm text-gray-900">需要外送 (滿 ${CONFIG_APP.FREE_DELIVERY_THRESHOLD} 免運)</label>
                    </div>
                    {delivery && (
                         <div>
                            <label className="block text-sm font-medium text-gray-700">外送地址</label>
                            <input type="text" value={address} onChange={e => setAddress(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" />
                        </div>
                    )}
                     <div>
                        <label className="block text-sm font-medium text-gray-700">備註</label>
                        <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={3} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"></textarea>
                    </div>
                    <button onClick={handleSubmit} disabled={isLoading} className="w-full flex justify-center items-center gap-2 px-4 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-red-300">
                        {isLoading ? <><i className="fas fa-spinner fa-spin"></i> 正在下單...</> : <><i className="fas fa-check"></i> 確認下單</>}
                    </button>
                </div>
            </div>
        </div>
    );
};


// --- START: index.tsx ---
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

</script>
  </body>
</html>
